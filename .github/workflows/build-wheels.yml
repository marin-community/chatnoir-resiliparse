name: Build Wheels

on:
  push:

env:
  PYTHON_VERSION: "3.12"
  FORCE_COLOR: "1"

jobs:
  build-wheels:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest ]
    env:
      CIBW_BUILD: "cp311-* cp312-*"
      CIBW_SKIP: "*-musllinux*"
      CIBW_ARCHS_MACOS: "x86_64 arm64"
      CIBW_ARCHS_LINUX: "x86_64"
      # CIBW_ARCHS_LINUX: "x86_64 aarch64"  # https://github.com/pypa/cibuildwheel/issues/1771#issuecomment-1973003145
      CIBW_MANYLINUX_X86_64_IMAGE: ghcr.io/chatnoir-eu/resiliparse-manylinux_2_28_x86_64:latest
      CIBW_MANYLINUX_AARCH64_IMAGE: ghcr.io/chatnoir-eu/resiliparse-manylinux_2_28_aarch64:latest
      CIBW_TEST_SKIP: "*-macosx_arm64 *-manylinux_aarch64 *"    # Skip all tests during wheel building
      CIBW_REPAIR_WHEEL_COMMAND_MACOS: >-
        DYLD_LIBRARY_PATH=$LIBRARY_PATH delocate-wheel --require-archs {delocate_archs} -w {dest_dir} {wheel}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Vcpkg
        uses: actions/cache@v4
        id: cache-vcpkg
        if: runner.os == 'macOS'
        with:
          path: |
            /usr/local/share/vcpkg/installed
          key: ${{ runner.os }}-vcpkg-15     # INCREMENT ME!!

      - name: Install Vcpkg Dependencies
        if: runner.os == 'macOS' && steps.cache-vcpkg.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -e

          VCPKG_CMD="vcpkg --overlay-ports .vcpkg/ports --overlay-triplets .vcpkg/triplets install"
          PKG_LIST="lexbor lz4 re2 uchardet zlib"

          $VCPKG_CMD --triplet=x64-osx $PKG_LIST
          $VCPKG_CMD --triplet=arm64-osx $PKG_LIST

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # - name: Set up QEMU
      #   if: runner.os == 'Linux'
      #   uses: docker/setup-qemu-action@v3
      #   with:
      #     platforms: aarch64

      - name: Build Resiliparse DOM
        uses: pypa/cibuildwheel@v2.16.5
        with:
          package-dir: resiliparse
          output-dir: wheelhouse

      - name: Upload Wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl

  publish-wheels:
    runs-on: ubuntu-latest
    needs: [ build-wheels ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          
      - name: Push Git Tag
        if: success()
        run: |
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\/v//')

          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@github.com"

          # For a regular release, the tag would already exist
          # This step is mainly useful for hotfixes or specific version pushes
          if ! git show-ref --tags v$VERSION; then
            git tag -a v$VERSION -m "Version $VERSION"
            git push origin v$VERSION
          fi

  publish-pypi-index:
    runs-on: ubuntu-latest
    needs: [ build-wheels ]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Download Wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: ./wheels

      - name: Generate PyPI Index
        run: |
          mkdir -p simple/resiliparse

          cat > simple/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head><title>Simple Index</title></head>
          <body>
            <a href="resiliparse/">resiliparse</a>
          </body>
          </html>
          EOF

          cat > simple/resiliparse/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head><title>Links for resiliparse</title></head>
          <body>
            <h1>Links for resiliparse</h1>
          EOF

          for wheel in wheels/*.whl; do
            if [ -f "$wheel" ]; then
              filename=$(basename "$wheel")
              echo "    <a href=\"../../wheels/$filename\">$filename</a><br/>" >> simple/resiliparse/index.html
            fi
          done

          cat >> simple/resiliparse/index.html << 'EOF'
          </body>
          </html>
          EOF

      - name: Commit and Push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"
          git add simple/ wheels/
          git commit -m "Update PyPI index for build ${{ github.sha }}" || echo "No changes to commit"
          git push