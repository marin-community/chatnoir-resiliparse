name: Build Wheels

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  FORCE_COLOR: "1"
  MACOSX_DEPLOYMENT_TARGET: "12.0"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-wheels:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    env:
      CIBW_SKIP: "*-musllinux* *cp38* *cp39*"
      CIBW_TEST_SKIP: "*"
      CIBW_ARCHS_MACOS: "arm64"
      CIBW_ARCHS_LINUX: "x86_64"
      CIBW_MANYLINUX_X86_64_IMAGE: ghcr.io/chatnoir-eu/resiliparse-manylinux_2_28_x86_64:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Vcpkg
        uses: actions/cache@v4
        id: cache-vcpkg
        if: runner.os == 'macOS'
        with:
          path: ./vcpkg_installed
          key: ${{ runner.os }}-vcpkg-21

      - name: Install Vcpkg Dependencies
        if: runner.os == 'macOS' && steps.cache-vcpkg.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -xe
          git clone https://github.com/Microsoft/vcpkg
          ./vcpkg/bootstrap-vcpkg.sh
          ./vcpkg/vcpkg install --triplet=arm64-osx

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build FastWARC
        uses: pypa/cibuildwheel@v2.22.0
        with:
          package-dir: fastwarc-py
          output-dir: wheelhouse

      - name: Build Resiliparse
        uses: pypa/cibuildwheel@v2.22.0
        with:
          package-dir: resiliparse-py
          output-dir: wheelhouse

      - name: Upload Wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl

  build-sdist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Build Module
        run: python -m pip install build

      - name: Build FastWARC Source Dist
        run: python -m build --sdist --outdir dist fastwarc-py

      - name: Build Resiliparse Source Dist
        run: python -m build --sdist --outdir dist resiliparse-py

      - name: Upload Source Dists
        uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: ./dist/*.tar.gz

  release:
    name: Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-wheels, build-sdist]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect wheels
        run: |
          mkdir -p dist
          find artifacts -name '*.whl' -exec cp {} dist/ \;
          find artifacts -name '*.tar.gz' -exec cp {} dist/ \;
          ls -la dist/

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          fail_on_unmatched_files: true

      - name: Create simple repository index
        run: |
          mkdir -p simple/resiliparse simple/fastwarc

          # Create resiliparse index
          cat > simple/resiliparse/index.html <<'HEREDOC'
          <!DOCTYPE html>
          <html>
            <head><title>Links for resiliparse</title></head>
            <body>
              <h1>Links for resiliparse</h1>
          HEREDOC

          for file in dist/resiliparse-* dist/Resiliparse-*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "      <a href=\"https://github.com/marin-community/chatnoir-resiliparse/releases/download/${{ github.ref_name }}/$filename\">$filename</a><br/>" >> simple/resiliparse/index.html
            fi
          done

          cat >> simple/resiliparse/index.html <<'HEREDOC'
            </body>
          </html>
          HEREDOC

          # Create fastwarc index
          cat > simple/fastwarc/index.html <<'HEREDOC'
          <!DOCTYPE html>
          <html>
            <head><title>Links for fastwarc</title></head>
            <body>
              <h1>Links for fastwarc</h1>
          HEREDOC

          for file in dist/fastwarc-* dist/FastWARC-*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "      <a href=\"https://github.com/marin-community/chatnoir-resiliparse/releases/download/${{ github.ref_name }}/$filename\">$filename</a><br/>" >> simple/fastwarc/index.html
            fi
          done

          cat >> simple/fastwarc/index.html <<'HEREDOC'
            </body>
          </html>
          HEREDOC

          # Create root index
          cat > simple/index.html <<'HEREDOC'
          <!DOCTYPE html>
          <html>
            <head><title>Simple index</title></head>
            <body>
              <a href="resiliparse/">resiliparse</a><br/>
              <a href="fastwarc/">fastwarc</a><br/>
            </body>
          </html>
          HEREDOC

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./simple
          keep_files: true
